<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eCFR Deregulation Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div id="app" class="container mx-auto p-6 max-w-7xl">
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg p-8 mb-6">
            <h1 class="text-4xl font-bold mb-2">eCFR Deregulation Analysis</h1>
            <p class="text-lg opacity-90">Analyzing all 50 CFR titles across 153 federal agencies</p>
            <p id="meta" class="text-sm opacity-75 mt-2">Loading...</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-6 text-center">
                <div class="text-3xl font-bold text-blue-600" id="stat-titles">-</div>
                <div class="text-sm text-gray-600 mt-1">Titles Analyzed</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6 text-center">
                <div class="text-3xl font-bold text-green-600" id="stat-agencies">-</div>
                <div class="text-sm text-gray-600 mt-1">Federal Agencies</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6 text-center">
                <div class="text-3xl font-bold text-purple-600" id="stat-words">-</div>
                <div class="text-sm text-gray-600 mt-1">Total Words (M)</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6 text-center">
                <div class="text-3xl font-bold text-red-600" id="stat-burden">-</div>
                <div class="text-sm text-gray-600 mt-1">Avg Burden Index</div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow mb-6">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold">CFR Titles Analysis</h2>
                <select id="sort" class="px-4 py-2 border rounded-lg">
                    <option value="burden">Sort by Burden</option>
                    <option value="word_count">Sort by Word Count</option>
                    <option value="complexity">Sort by Complexity</option>
                    <option value="velocity">Sort by Change Velocity</option>
                </select>
            </div>
            <div id="titles-list" class="divide-y">
                <div class="p-8 text-center text-gray-500">Loading titles...</div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow">
            <div class="p-6 border-b">
                <h2 class="text-2xl font-bold">Agency Regulatory Footprint</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rank</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Agency</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Short Name</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Titles</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Chapters</th>
                        </tr>
                    </thead>
                    <tbody id="agencies-list" class="divide-y">
                        <tr><td colspan="5" class="p-8 text-center text-gray-500">Loading agencies...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // REPLACE THESE WITH YOUR SUPABASE CREDENTIALS
        const SUPABASE_URL = 'https://loyuoxwhowhhmzoywexb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxveXVveHdob3doaG16b3l3ZXhiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNTQwMTEsImV4cCI6MjA4NTczMDAxMX0.-Net5OaKbEpNiI50K0hy__eJbmJXF_MCQ2g29gLLPTs
';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let titlesData = [];
        let agenciesData = [];
        
        async function loadData() {
            try {
                // Fetch metadata
                const { data: meta } = await supabase.from('metadata').select('*').single();
                if (meta) {
                    document.getElementById('meta').textContent = 
                        `Generated: ${new Date(meta.generated_at).toLocaleString()}`;
                    document.getElementById('stat-titles').textContent = meta.total_titles;
                    document.getElementById('stat-agencies').textContent = meta.total_agencies;
                }
                
                // Fetch titles
                const { data: titles } = await supabase.from('titles').select('*');
                titlesData = titles || [];
                
                // Calculate stats
                const totalWords = titlesData.reduce((sum, t) => sum + t.word_count, 0);
                const avgBurden = titlesData.reduce((sum, t) => sum + t.burden, 0) / titlesData.length;
                document.getElementById('stat-words').textContent = (totalWords / 1000000).toFixed(1);
                document.getElementById('stat-burden').textContent = avgBurden.toFixed(2);
                
                // Fetch agencies
                const { data: agencies } = await supabase.from('agencies').select('*');
                agenciesData = agencies || [];
                
                renderTitles();
                renderAgencies();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('titles-list').innerHTML = 
                    '<div class="p-8 text-center text-red-500">Error loading data. Check console.</div>';
            }
        }
        
        function renderTitles() {
            const sortBy = document.getElementById('sort').value;
            const sorted = [...titlesData].sort((a, b) => b[sortBy] - a[sortBy]);
            
            const html = sorted.map(t => `
                <div class="p-4 hover:bg-gray-50 cursor-pointer" onclick="toggleDetails(${t.title_number})">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <div class="font-bold text-lg">Title ${t.title_number}: ${t.title_name}</div>
                            <div class="text-sm text-gray-600">Last amended: ${t.last_amended}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold ${t.burden > 7 ? 'text-red-600' : t.burden > 4 ? 'text-yellow-600' : 'text-green-600'}">
                                ${t.burden.toFixed(1)}
                            </div>
                            <div class="text-xs text-gray-500">Burden Index</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">Words:</span>
                            <span class="font-semibold ml-1">${(t.word_count / 1000000).toFixed(1)}M</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Sections:</span>
                            <span class="font-semibold ml-1">${t.sections.toLocaleString()}</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Complexity:</span>
                            <span class="font-semibold ml-1">${t.complexity.toFixed(1)}</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Velocity:</span>
                            <span class="font-semibold ml-1">${t.velocity.toFixed(1)}/yr</span>
                        </div>
                    </div>
                    <div id="details-${t.title_number}" class="hidden mt-4 p-4 bg-blue-50 rounded">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <div class="font-medium mb-2">Structure</div>
                                <div class="space-y-1">
                                    <div>Parts: ${t.parts}</div>
                                    <div>Sections: ${t.sections}</div>
                                    <div>Density: ${t.density} sections/part</div>
                                </div>
                            </div>
                            <div>
                                <div class="font-medium mb-2">Change History</div>
                                <div class="space-y-1">
                                    <div>Substantive changes: ${t.substantive_changes}</div>
                                    <div>Removed sections: ${t.removed_sections}</div>
                                    <div>Checksum: ${t.checksum}</div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 p-3 ${t.burden > 7 ? 'bg-red-100 text-red-900' : 'bg-green-100 text-green-900'} rounded">
                            <strong>Recommendation:</strong> 
                            ${t.burden > 7 ? 'High burden - priority for comprehensive review' : 
                              t.burden > 4 ? 'Moderate burden - targeted improvements recommended' : 
                              'Lower burden - maintain current efficiency'}
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('titles-list').innerHTML = html;
        }
        
        function renderAgencies() {
            const html = agenciesData.slice(0, 30).map((a, i) => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 font-medium">${i + 1}</td>
                    <td class="px-4 py-3">${a.name}</td>
                    <td class="px-4 py-3 font-semibold">${a.short_name}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded font-medium">
                            ${a.title_count}
                        </span>
                    </td>
                    <td class="px-4 py-3">${a.chapter_count}</td>
                </tr>
            `).join('');
            
            document.getElementById('agencies-list').innerHTML = html;
        }
        
        function toggleDetails(titleNum) {
            const el = document.getElementById(`details-${titleNum}`);
            el.classList.toggle('hidden');
        }
        
        document.getElementById('sort').addEventListener('change', renderTitles);
        
        loadData();
    </script>
</body>
</html>
